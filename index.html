<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escape the Maze</title>
    <!-- Подключение Tailwind CSS CDN для стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Применение темного фона и шрифта Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Темный фон */
            color: #e2e8f0; /* Светлый текст */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Стиль для Canvas, чтобы он сохранял квадратную форму и был адаптивным */
        #gameCanvas {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.5); /* Голубое свечение вокруг лабиринта */
            display: block;
            touch-action: none;
        }

        /* Общий стиль для кнопок и модальных окон */
        .btn-primary {
            @apply px-4 py-2 font-semibold text-sm rounded-lg shadow-md transition duration-200 ease-in-out;
        }

        .btn-cyan {
            @apply btn-primary bg-cyan-600 text-white hover:bg-cyan-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-75;
        }

        .btn-emerald {
            @apply btn-primary bg-emerald-600 text-white hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-75;
        }
        
        /* Стиль для кнопок вариантов викторины */
        .btn-quiz-option {
            @apply block w-full text-xl py-5 px-6 font-extrabold text-white rounded-2xl shadow-xl 
                   transition duration-300 ease-in-out cursor-pointer border-b-4 border-indigo-600
                   mb-8;
            min-height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-image: linear-gradient(to right, #38bdf8, #6366f1); 
            @apply hover:scale-[1.01] hover:shadow-2xl hover:shadow-indigo-500/50;
            @apply focus:outline-none focus:ring-4 focus:ring-sky-400 active:bg-indigo-600;
        }

        .btn-quiz-option:last-child {
            @apply mb-0;
        }

        /* УЛУЧШЕННЫЕ МОБИЛЬНЫЕ КОНТРОЛЫ */
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border-top: 3px solid rgba(6, 182, 212, 0.5);
            padding: 15px 10px 25px 10px;
            z-index: 50;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
                justify-content: space-around;
                align-items: center;
                gap: 15px;
            }
            
            body {
                padding-bottom: 200px !important;
            }
        }

        /* D-PAD КНОПКИ */
        .dpad-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
            width: 150px;
            height: 150px;
        }

        .dpad-btn {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 3px solid rgba(6, 182, 212, 0.7);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #06b6d4;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 
                inset 0 4px 8px rgba(255, 255, 255, 0.1),
                0 6px 15px rgba(0, 0, 0, 0.3);
            touch-action: manipulation;
            min-height: 45px;
            position: relative;
            overflow: hidden;
        }

        .dpad-btn:active, .dpad-btn.active {
            background: linear-gradient(145deg, #0ea5e9, #0284c7);
            border-color: #38bdf8;
            color: white;
            transform: scale(0.92);
        }

        .dpad-up {
            grid-column: 2;
            grid-row: 1;
        }

        .dpad-right {
            grid-column: 3;
            grid-row: 2;
        }

        .dpad-down {
            grid-column: 2;
            grid-row: 3;
        }

        .dpad-left {
            grid-column: 1;
            grid-row: 2;
        }

        .dpad-center {
            grid-column: 2;
            grid-row: 2;
            background: linear-gradient(145deg, rgba(6, 182, 212, 0.2), rgba(6, 182, 212, 0.1));
            border: 3px solid rgba(6, 182, 212, 0.4);
            font-size: 1rem;
            color: #67e8f9;
        }

        /* ДЖОЙСТИК */
        .joystick-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .joystick {
            width: 130px;
            height: 130px;
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 50%;
            border: 4px solid rgba(6, 182, 212, 0.7);
            position: relative;
            box-shadow: 
                inset 0 4px 8px rgba(255, 255, 255, 0.1),
                0 8px 25px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            touch-action: none;
        }

        .joystick-handle {
            width: 55px;
            height: 55px;
            background: linear-gradient(145deg, #0ea5e9, #0284c7);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.08s cubic-bezier(0.22, 1, 0.36, 1);
            box-shadow: 
                0 4px 15px rgba(14, 165, 233, 0.5),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }

        .joystick-label {
            color: #67e8f9;
            font-size: 0.9rem;
            margin-top: 8px;
            font-weight: 600;
        }

        /* КНОПКА ДЕЙСТВИЙ */
        .action-btn {
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 
                0 6px 20px rgba(16, 185, 129, 0.4),
                inset 0 2px 4px rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.1);
            min-height: 50px;
            min-width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        /* АДАПТАЦИЯ ДЛЯ МАЛЕНЬКИХ ЭКРАНОВ */
        @media (max-width: 480px) {
            .mobile-controls {
                gap: 10px;
            }
            
            .joystick {
                width: 110px;
                height: 110px;
            }
            
            .joystick-handle {
                width: 45px;
                height: 45px;
            }
            
            .dpad-container {
                width: 130px;
                height: 130px;
            }
            
            .dpad-btn {
                font-size: 1.5rem;
                min-height: 40px;
            }
            
            .action-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                min-width: 90px;
            }
        }

        @media (max-width: 380px) {
            .mobile-controls {
                flex-direction: column;
                gap: 15px;
                padding-bottom: 20px;
            }
            
            .action-btn {
                order: -1;
                width: 80%;
                margin-bottom: 5px;
            }
        }

        @media (min-width: 769px) {
            .mobile-controls {
                display: none !important;
            }
        }

        /* Стиль для модального окна */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 1rem;
        }

        .modal-content {
            background-color: #1e293b;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            min-width: 300px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7);
            border: 2px solid #06b6d4;
            margin: auto;
        }
        
        #quizOptions {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
    </style>
</head>
<body class="selection:bg-cyan-800 selection:text-white">

    <!-- Основной контейнер игры -->
    <div class="flex flex-col lg:flex-row items-start lg:items-center justify-center space-y-8 lg:space-y-0 lg:space-x-12 w-full max-w-6xl">

        <!-- Панель статистики и ключей -->
        <div class="w-full lg:w-64 p-6 bg-[#1e293b] rounded-xl shadow-lg border border-gray-700 order-2 lg:order-1">
            <h2 class="text-xl font-bold text-white mb-4 border-b pb-2 border-cyan-700">Статистика</h2>
            
            <div class="space-y-3">
                <p class="flex justify-between text-lg">
                    <span>Время:</span> 
                    <span id="timerDisplay" class="font-mono text-cyan-400">00:00.0</span>
                </p>
                <p class="flex justify-between text-lg">
                    <span>Шаги:</span> 
                    <span id="stepsDisplay" class="font-mono text-cyan-400">0</span>
                </p>
            </div>

            <h2 class="text-xl font-bold text-white mt-6 mb-3 border-b pb-2 border-cyan-700">
                Ключи (10)
            </h2>
            <div id="keyIcons" class="grid grid-cols-5 gap-2">
                <!-- Иконки ключей будут сгенерированы JS -->
            </div>

            <div class="mt-8 space-y-3">
                <button id="newMazeBtn" class="w-full btn-cyan">
                    Новый Лабиринт
                </button>
                <button id="replayBtn" class="w-full btn-emerald">
                    Переиграть
                </button>
            </div>
        </div>

        <!-- Контейнер для Canvas -->
        <div class="relative flex-shrink-0 w-full max-w-lg aspect-square order-1 lg:order-2">
            <canvas id="gameCanvas" width="700" height="700"></canvas>
            <div id="messageOverlay" class="absolute inset-0 flex items-center justify-center text-4xl font-bold text-cyan-400 bg-black bg-opacity-70 rounded-lg hidden">
                Нажмите любую стрелку или WASD, чтобы начать!
            </div>
        </div>

    </div>
    
    <!-- МОБИЛЬНЫЕ КОНТРОЛЫ -->
    <div class="mobile-controls">
        <button class="action-btn" id="mobileActionBtn">
            НОВАЯ ИГРА
        </button>
        
        <div class="joystick-container">
            <div class="joystick" id="joystick">
                <div class="joystick-handle" id="joystickHandle"></div>
            </div>
            <div class="joystick-label">Джойстик</div>
        </div>
        
        <div class="dpad-container">
            <button class="dpad-btn dpad-up" data-direction="up">↑</button>
            <button class="dpad-btn dpad-right" data-direction="right">→</button>
            <button class="dpad-btn dpad-down" data-direction="down">↓</button>
            <button class="dpad-btn dpad-left" data-direction="left">←</button>
            <div class="dpad-btn dpad-center">D-PAD</div>
        </div>
    </div>
    
    <!-- Модальное окно для викторины -->
    <div id="quizModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-cyan-400 mb-4">Подберите ключ!</h3>
            <p id="quizQuestion" class="text-white text-xl mb-6"></p>
            <div id="quizOptions" class="space-y-0">
                <!-- Кнопки вариантов ответа -->
            </div>
        </div>
    </div>

    <!-- Модальное окно победы -->
    <div id="victoryModal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 class="text-4xl font-extrabold text-emerald-400 mb-4">ПОБЕДА!</h3>
            <p class="text-2xl text-white mb-2">Вы нашли выход.</p>
            <p id="victoryMessage" class="lg:text-lg text-cyan-300 font-semibold mb-6"></p>
            <div class="space-y-2">
                <p class="text-xl">Финальное время: <span id="finalTime" class="font-mono text-emerald-400"></span></p>
                <p class="text-xl">Всего шагов: <span id="finalSteps" class="font-mono text-emerald-400"></span></p>
            </div>
            <button onclick="initGame()" class="btn-cyan mt-8">
                Начать новую игру
            </button>
        </div>
    </div>

    <script>
        // === КОНСТАНТЫ И НАСТРОЙКИ ===
        const GRID_SIZE = 15; 
        const CELL_SIZE = 20; // Изначальный размер в пикселях (будет пересчитан)
        const ENEMY_COUNT = 5;
        const KEY_COUNT = 10;
        const ENEMY_MOVE_CHANCE = 0.3; // 30% шанс движения
        const COLORS = {
            WALL: '#475569',    // СЕРЫЙ: Видимые стены (slate-600)
            PATH: '#1e293b',    // Цвет проходимого пути (slate-800)
            PLAYER: '#06b6d4',  // Cyan-500
            PLAYER_GLOW: 'rgba(6, 182, 212, 0.6)', // Голубое свечение
            KEY: '#fbbf24',     // Amber-400
            EXIT: '#10b981',    // Emerald-600
            ENEMY: '#ef4444',   // Red-500
            STATS_BG: '#1e293b' // Цвет панели статистики
        };

        // ДАННЫЕ ВИКТОРИНЫ (2 варианта ответа)
        const KEY_QUIZ_DATA_RAW = `
Look! The cat ____ on the sofa.,is sleeping,sleeps,1
They ____ football every Saturday.,play,are playing,1
My dad always ____ coffee in the morning.,drinks,is drinking,1
Listen! John ____ his favorite song.,is singing,sings,1
I ____ TV right now.,am not watching,don't watch,1
What ____ you doing now?,are,do,1
She usually ____ her mother in the kitchen.,helps,is helping,1
We ____ to school today because it is Sunday.,don't go,aren't going,1
____ he like bananas?,Does,Is,1
Every year they ____ their grandparents.,visit,are visiting,1
The sun ____ brightly now.,is shining,shines,1
He often ____ his keys at home.,forgets,is forgetting,1
Be quiet! The baby ____.,is sleeping,sleeps,1
They ____ fast food.,don't like,aren't liking,1
Your friends ____ right now.,are studying,study,1
We never ____ meat.,eat,are eating,1
I ____ a very interesting book at the moment.,am reading,read,1
Where ____ she work?,does,is,1
Look! A big ship ____ on the sea.,is sailing,sails,1
He ____ computer games every day.,doesn't play,isn't playing,1
The train always ____ at 7 a.m.,leaves,is leaving,1
____ you listen to the radio every evening?,Do,Are,1
Right now my brother ____ a tower with blocks.,is building,builds,1
Tom ____ a shower every morning.,has,is having,1
They ____ a movie right now.,are watching,watch,1
What time ____ the store open on weekdays?,does,is,1
My parents ____ today.,aren't working,don't work,1
She ____ a beautiful dress at the moment.,is wearing,wears,1
We usually ____ summer holidays at the seaside.,spend,are spending,1
____ it raining outside now?,Is,Does,1
He ____ breakfast usually.,doesn't eat,isn't eating,1
He always ____ to school on time.,comes,is coming,1
They ____ on the phone right now.,are talking,talk,1
____ I look happy today?,Do,Am,1
The children often ____ to the library.,go,are going,1
I ____ my phone right now.,am not using,don't use,1
She ____ a cake every Friday.,makes,is making,1
Listen! Who ____ at the door?,is knocking,knocks,1
We ____ English every day.,study,are studying,1
What ____ your mom cooking now?,is,does,1
They ____ TV usually.,don't watch,aren't watching,1
He always ____ his homework before dinner.,finishes,is finishing,1
____ the dog chasing the cat right now?,Is,Does,1
My friend ____ in a big city.,lives,is living,1
Look! The teacher ____ on the board.,is writing,writes,1
I ____ to bed at 10 p.m. every night.,go,am going,1
____ you like ice cream?,Do,Are,1
We ____ lunch at the moment.,are having,have,1
She never ____ when she is sad.,cries,is crying,1
What ____ you do every weekend?,do,are,1
        `;

        // Парсинг данных викторины
        const KEY_QUIZ_DATA = KEY_QUIZ_DATA_RAW.trim().split('\n')
            .map(line => line.trim()) 
            .filter(line => line.length > 0) 
            .map(line => {
            const parts = line.split(',').map(p => p.trim());
            
            if (parts.length !== 4) {
                console.error("Не удалось разобрать строку викторины:", line);
                return null; 
            }
            
            const correctIndex = parseInt(parts[3]) - 1;
            if (isNaN(correctIndex) || correctIndex < 0 || correctIndex > 1) {
                 console.error("Некорректный индекс ответа:", line);
                 return null;
            }
            
            return {
                task: parts[0],
                options: [parts[1], parts[2]],
                correct: correctIndex
            };
        }).filter(item => item !== null);

        if (KEY_QUIZ_DATA.length === 0) {
            console.warn("Нет корректных данных викторины.");
            KEY_QUIZ_DATA.push({
                task: "Что ____ вы делаете?",
                options: ["делаете", "делает"],
                correct: 0
            });
        }

        // === ПЕРЕМЕННЫЕ ИГРЫ ===
        let canvas, ctx;
        let maze;
        let player = { x: 0, y: 0 };
        let cellWidth;
        let keys = [];
        let collectedKeyIds = new Set();
        let enemies = [];
        let exit = null;
        let gameActive = false;
        let steps = 0;
        let startTime;
        let timerInterval;
        let keysRemaining = KEY_COUNT;
        let currentKeyId = null;

        // === МОБИЛЬНЫЕ КОНТРОЛЫ ===
        let joystickActive = false;
        let joystickDirection = { x: 0, y: 0 };
        let moveInterval = null;

        // === ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===

        function generateMaze(rows, cols) {
            // Структура ячейки: 0=N, 1=E, 2=S, 3=W
            class Cell {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.walls = [true, true, true, true]; // [N, E, S, W]
                    this.visited = false;
                }
            }

            const grid = [];
            for (let y = 0; y < rows; y++) {
                const row = [];
                for (let x = 0; x < cols; x++) {
                    row.push(new Cell(x, y));
                }
                grid.push(row);
            }

            const stack = [];
            let current = grid[0][0];
            current.visited = true;
            stack.push(current);

            const dx = [0, 1, 0, -1];
            const dy = [-1, 0, 1, 0];
            const opposite = [2, 3, 0, 1];

            while (stack.length > 0) {
                current = stack.pop();

                const unvisitedNeighbors = [];
                for (let i = 0; i < 4; i++) {
                    const nx = current.x + dx[i];
                    const ny = current.y + dy[i];

                    if (nx >= 0 && nx < cols && ny >= 0 && ny < rows && !grid[ny][nx].visited) {
                        unvisitedNeighbors.push({ cell: grid[ny][nx], dir: i });
                    }
                }

                if (unvisitedNeighbors.length > 0) {
                    stack.push(current);

                    const { cell: next, dir } = unvisitedNeighbors[Math.floor(Math.random() * unvisitedNeighbors.length)];

                    // Удаление стен
                    current.walls[dir] = false;
                    next.walls[opposite[dir]] = false;

                    next.visited = true;
                    stack.push(next);
                }
            }
            return grid;
        }

        function findRandomPassableLocation() {
            let x, y, cell;
            do {
                x = Math.floor(Math.random() * GRID_SIZE);
                y = Math.floor(Math.random() * GRID_SIZE);
                cell = maze[y][x];
            } while (cell.x === player.x && cell.y === player.y || collectedKeyIds.has(cell.x + '-' + cell.y));
            return { x, y };
        }

        function draw() {
            if (!ctx) return;

            // 1. Очистка (цвет пути)
            ctx.fillStyle = COLORS.PATH;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. Отрисовка лабиринта (стен)
            const wallThickness = 1;
            ctx.fillStyle = COLORS.WALL;

            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    const cell = maze[y][x];
                    const left = x * cellWidth;
                    const top = y * cellWidth;

                    // Верхняя стена (N)
                    if (cell.walls[0]) {
                        ctx.fillRect(left, top, cellWidth + wallThickness, wallThickness);
                    }
                    // Правая стена (E)
                    if (cell.walls[1]) {
                        ctx.fillRect(left + cellWidth - wallThickness, top, wallThickness, cellWidth + wallThickness);
                    }
                    // Нижняя стена (S)
                    if (cell.walls[2]) {
                        ctx.fillRect(left, top + cellWidth - wallThickness, cellWidth + wallThickness, wallThickness);
                    }
                    // Левая стена (W)
                    if (cell.walls[3]) {
                        ctx.fillRect(left, top, wallThickness, cellWidth + wallThickness);
                    }
                }
            }
            
            // 3. Отрисовка Ключей
            keys.filter(k => !collectedKeyIds.has(k.id)).forEach(key => {
                drawCircle(key.x, key.y, COLORS.KEY, cellWidth * 0.25);
            });

            // 4. Отрисовка Выхода (если все ключи собраны)
            if (exit) {
                drawCircle(exit.x, exit.y, COLORS.EXIT, cellWidth * 0.35);
            }
            
            // 5. Отрисовка Врагов (если есть)
            enemies.forEach(enemy => {
                drawCircle(enemy.x, enemy.y, COLORS.ENEMY, cellWidth * 0.3);
            });

            // 6. Отрисовка Игрока
            ctx.save();
            // Эффект свечения
            ctx.shadowColor = COLORS.PLAYER_GLOW;
            ctx.shadowBlur = cellWidth * 0.5;
            drawCircle(player.x, player.y, COLORS.PLAYER, cellWidth * 0.35);
            ctx.restore();
        }

        function drawCircle(x, y, color, radius) {
            const centerX = x * cellWidth + cellWidth / 2;
            const centerY = y * cellWidth + cellWidth / 2;

            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.fill();
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            const containerSize = Math.min(container.offsetWidth, container.offsetHeight);
            
            canvas.width = containerSize;
            canvas.height = containerSize;

            cellWidth = canvas.width / GRID_SIZE;

            if (gameActive) {
                draw();
            }
        }

        function initializeKeys() {
            keys = [];
            collectedKeyIds.clear();
            
            const keyIconsContainer = document.getElementById('keyIcons');
            keyIconsContainer.innerHTML = '';
            
            for (let i = 0; i < KEY_COUNT; i++) {
                const pos = findRandomPassableLocation();
                const quizIndex = i % KEY_QUIZ_DATA.length;

                const key = {
                    x: pos.x,
                    y: pos.y,
                    id: i,
                    quizIndex: quizIndex
                };
                keys.push(key);

                const icon = document.createElement('div');
                icon.id = `key-icon-${i}`;
                icon.className = `w-6 h-6 rounded-full bg-yellow-400/30 transition-opacity duration-300`;
                keyIconsContainer.appendChild(icon);
            }
        }

        function initializeEnemiesAndExit() {
            exit = findRandomPassableLocation();

            enemies = [];
            for (let i = 0; i < ENEMY_COUNT; i++) {
                const pos = findRandomPassableLocation();
                enemies.push({ x: pos.x, y: pos.y });
            }
        }

        function relocateExit() {
            exit = findRandomPassableLocation();
        }

        function updateEnemies() {
            if (enemies.length === 0) return;

            const wallDirMap = [0, 1, 2, 3];

            enemies.forEach(enemy => {
                if (enemy.y < 0 || enemy.y >= GRID_SIZE || enemy.x < 0 || enemy.x >= GRID_SIZE) {
                     const newPos = findRandomPassableLocation();
                     enemy.x = newPos.x;
                     enemy.y = newPos.y;
                     return;
                }

                if (Math.random() < ENEMY_MOVE_CHANCE) {
                    const potentialMoves = [];
                    const currentEnemyCell = maze[enemy.y][enemy.x];
                    
                    for (let i = 0; i < 4; i++) {
                        const dir = wallDirMap[i];
                        
                        if (!currentEnemyCell.walls[dir]) {
                            potentialMoves.push(i);
                        }
                    }

                    if (potentialMoves.length > 0) {
                        const moveIndex = potentialMoves[Math.floor(Math.random() * potentialMoves.length)];
                        
                        const dx_move = [0, 1, 0, -1];
                        const dy_move = [-1, 0, 1, 0];

                        enemy.x += dx_move[moveIndex];
                        enemy.y += dy_move[moveIndex];

                        if (enemy.x === player.x && enemy.y === player.y) {
                            relocateExit();
                        }
                    }
                }
            });
            draw();
        }

        function handleQuizAnswer(isCorrect) {
            document.getElementById('quizModal').style.display = 'none';
            gameActive = true;

            if (isCorrect) {
                collectedKeyIds.add(currentKeyId);
                keysRemaining--;

                const icon = document.getElementById(`key-icon-${currentKeyId}`);
                if (icon) {
                    icon.classList.remove('bg-yellow-400/30');
                    icon.classList.add('bg-yellow-400');
                }

                if (keysRemaining === 0) {
                    initializeEnemiesAndExit();
                }

            } else {
                const keyIndex = keys.findIndex(k => k.id === currentKeyId);
                if (keyIndex !== -1) {
                    const newPos = findRandomPassableLocation();
                    keys[keyIndex].x = newPos.x;
                    keys[keyIndex].y = newPos.y;
                    
                    keys[keyIndex].quizIndex = Math.floor(Math.random() * KEY_QUIZ_DATA.length);
                }
            }

            draw();
            currentKeyId = null;
        }

        function showQuizModal(key) {
            gameActive = false;
            currentKeyId = key.id;

            if (key.quizIndex >= KEY_QUIZ_DATA.length) {
                 console.error(`Ошибка: quizIndex ${key.quizIndex} находится за пределами диапазона.`);
                 handleQuizAnswer(false);
                 return;
            }

            const quiz = KEY_QUIZ_DATA[key.quizIndex];
            
            document.getElementById('quizQuestion').textContent = `Выберите правильный вариант: "${quiz.task}"`;
            
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';

            quiz.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.innerHTML = `<span>${option}</span>`;
                btn.className = 'btn-quiz-option';

                const isCorrect = index === quiz.correct;
                btn.onclick = () => handleQuizAnswer(isCorrect);
                
                optionsContainer.appendChild(btn);
            });

            document.getElementById('quizModal').style.display = 'flex';
        }

        // ОСНОВНАЯ ФУНКЦИЯ ДВИЖЕНИЯ
        function movePlayer(dx, dy) {
            if (!gameActive) return;

            let wallIndex = -1;
            if (dx === -1 && dy === 0) wallIndex = 3; // left
            if (dx === 1 && dy === 0) wallIndex = 1; // right
            if (dx === 0 && dy === -1) wallIndex = 0; // up
            if (dx === 0 && dy === 1) wallIndex = 2; // down

            const currentCell = maze[player.y][player.x];
            if (currentCell.walls[wallIndex]) {
                return;
            }

            player.x += dx;
            player.y += dy;
            steps++;
            document.getElementById('stepsDisplay').textContent = steps;

            const key = keys.find(k => k.x === player.x && k.y === player.y && !collectedKeyIds.has(k.id));
            if (key) {
                showQuizModal(key);
            }

            if (enemies.length > 0) {
                const enemyHit = enemies.some(e => e.x === player.x && e.y === player.y);
                if (enemyHit) {
                    relocateExit();
                }
            }

            if (exit && player.x === exit.x && player.y === exit.y) {
                stopTimer();
                showVictoryModal();
            }

            draw();
        }

        function initGame() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            if (KEY_QUIZ_DATA.length === 0) {
                 document.getElementById('messageOverlay').textContent = "ОШИБКА: Вопросы викторины не загружены.";
                 document.getElementById('messageOverlay').style.display = 'flex';
                 gameActive = false;
                 stopTimer();
                 return;
            }

            maze = generateMaze(GRID_SIZE, GRID_SIZE);
            player = { x: 0, y: 0 };
            steps = 0;
            keysRemaining = KEY_COUNT;
            exit = null;
            enemies = [];
            currentKeyId = null;
            joystickDirection = { x: 0, y: 0 };

            document.getElementById('stepsDisplay').textContent = 0;
            document.getElementById('timerDisplay').textContent = '00:00.0';
            document.getElementById('messageOverlay').style.display = 'flex';
            document.getElementById('messageOverlay').textContent = 'Нажмите любую стрелку или WASD, чтобы начать!';
            document.getElementById('quizModal').style.display = 'none';
            document.getElementById('victoryModal').style.display = 'none';
            document.getElementById('keyIcons').innerHTML = '';
            
            initializeKeys();
            
            resizeCanvas();
            window.removeEventListener('resize', resizeCanvas);
            window.addEventListener('resize', resizeCanvas);

            stopTimer();
            gameActive = false;
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(gameLoop, 100);
            
            if (moveInterval) clearInterval(moveInterval);
            moveInterval = null;
            
            resetJoystick();
            draw();
        }

        function gameLoop() {
            if (!gameActive) {
                if (enemies.length > 0) {
                     updateEnemies();
                }
                return;
            }

            if (startTime) {
                const elapsed = Date.now() - startTime;
                const totalSeconds = elapsed / 1000;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const decisecond = Math.floor((totalSeconds * 10) % 10);

                const timerText = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${decisecond}`;
                document.getElementById('timerDisplay').textContent = timerText;
            }

            updateEnemies();
        }

        function startTimer() {
            if (startTime) return;
            startTime = Date.now();
        }

        function stopTimer() {
            startTime = null;
        }

        function showVictoryModal() {
            gameActive = false;
            
            let finalTimeText = '00:00.0';
            if (startTime) {
                const elapsed = Date.now() - startTime;
                const totalSeconds = elapsed / 1000;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                
                finalTimeText = `${String(minutes).padStart(2, '0')}:${seconds.toFixed(1).padStart(4, '0')}`;
            }
            
            document.getElementById('finalTime').textContent = finalTimeText;
            document.getElementById('finalSteps').textContent = steps;
            document.getElementById('victoryMessage').textContent = "Perfect route!";

            document.getElementById('victoryModal').style.display = 'flex';
        }

        // === МОБИЛЬНЫЕ КОНТРОЛЫ ===
        function initMobileControls() {
            const joystick = document.getElementById('joystick');
            const joystickHandle = document.getElementById('joystickHandle');
            const dpadButtons = document.querySelectorAll('.dpad-btn[data-direction]');
            const mobileActionBtn = document.getElementById('mobileActionBtn');
            
            // Джойстик события
            joystick.addEventListener('touchstart', handleJoystickStart);
            document.addEventListener('touchmove', handleJoystickMove);
            document.addEventListener('touchend', handleJoystickEnd);
            
            function handleJoystickStart(e) {
                e.preventDefault();
                joystickActive = true;
                if (!gameActive) {
                    document.getElementById('messageOverlay').style.display = 'none';
                    gameActive = true;
                    startTimer();
                }
                updateJoystick(e);
            }
            
            function handleJoystickMove(e) {
                if (!joystickActive) return;
                e.preventDefault();
                updateJoystick(e);
            }
            
            function handleJoystickEnd(e) {
                joystickActive = false;
                resetJoystick();
                stopContinuousMove();
            }
            
            function updateJoystick(e) {
                const rect = joystick.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const touch = e.touches[0];
                const touchX = touch.clientX;
                const touchY = touch.clientY;
                
                let deltaX = touchX - centerX;
                let deltaY = touchY - centerY;
                
                const maxDistance = rect.width / 3;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (distance > maxDistance) {
                    const angle = Math.atan2(deltaY, deltaX);
                    deltaX = Math.cos(angle) * maxDistance;
                    deltaY = Math.sin(angle) * maxDistance;
                }
                
                const handleX = (deltaX / (rect.width / 2)) * 50;
                const handleY = (deltaY / (rect.height / 2)) * 50;
                joystickHandle.style.transform = `translate(${handleX}%, ${handleY}%)`;
                
                let newDirection = { x: 0, y: 0 };
                const threshold = rect.width / 6;
                
                if (Math.abs(deltaX) > threshold) {
                    newDirection.x = deltaX > 0 ? 1 : -1;
                }
                if (Math.abs(deltaY) > threshold) {
                    newDirection.y = deltaY > 0 ? 1 : -1;
                }
                
                if (newDirection.x !== joystickDirection.x || newDirection.y !== joystickDirection.y) {
                    joystickDirection = newDirection;
                    updateMovement();
                }
            }
            
            function resetJoystick() {
                joystickHandle.style.transform = 'translate(-50%, -50%)';
                joystickDirection = { x: 0, y: 0 };
                updateMovement();
            }
            
            // D-Pad события
            dpadButtons.forEach(btn => {
                let isPressed = false;
                let pressTimer = null;
                
                const startPress = (e) => {
                    e.preventDefault();
                    isPressed = true;
                    if (!gameActive) {
                        document.getElementById('messageOverlay').style.display = 'none';
                        gameActive = true;
                        startTimer();
                    }
                    const direction = btn.dataset.direction;
                    setDirectionFromDpad(direction, btn);
                    
                    pressTimer = setInterval(() => {
                        if (isPressed) {
                            movePlayer(joystickDirection.x, joystickDirection.y);
                        }
                    }, 200);
                };
                
                const endPress = (e) => {
                    e.preventDefault();
                    isPressed = false;
                    if (pressTimer) {
                        clearInterval(pressTimer);
                        pressTimer = null;
                    }
                    joystickDirection = { x: 0, y: 0 };
                    updateMovement();
                    btn.classList.remove('active');
                };
                
                btn.addEventListener('touchstart', startPress);
                btn.addEventListener('touchend', endPress);
                btn.addEventListener('touchcancel', endPress);
                
                btn.addEventListener('mousedown', startPress);
                btn.addEventListener('mouseup', endPress);
                btn.addEventListener('mouseleave', endPress);
            });
            
            function setDirectionFromDpad(direction, btn) {
                switch(direction) {
                    case 'up':
                        joystickDirection = { x: 0, y: -1 };
                        break;
                    case 'right':
                        joystickDirection = { x: 1, y: 0 };
                        break;
                    case 'down':
                        joystickDirection = { x: 0, y: 1 };
                        break;
                    case 'left':
                        joystickDirection = { x: -1, y: 0 };
                        break;
                }
                updateMovement();
                btn.classList.add('active');
            }
            
            function updateMovement() {
                if (moveInterval) {
                    clearInterval(moveInterval);
                }
                
                if (joystickDirection.x !== 0 || joystickDirection.y !== 0) {
                    movePlayer(joystickDirection.x, joystickDirection.y);
                    
                    moveInterval = setInterval(() => {
                        movePlayer(joystickDirection.x, joystickDirection.y);
                    }, 200);
                } else {
                    if (moveInterval) {
                        clearInterval(moveInterval);
                        moveInterval = null;
                    }
                }
            }
            
            function stopContinuousMove() {
                if (moveInterval) {
                    clearInterval(moveInterval);
                    moveInterval = null;
                }
            }
            
            // Кнопка действия
            mobileActionBtn.addEventListener('click', initGame);
        }

        // === КЛАВИАТУРНОЕ УПРАВЛЕНИЕ ===
        function handleKeyDown(e) {
            if (document.getElementById('quizModal').style.display === 'flex' || 
                document.getElementById('victoryModal').style.display === 'flex') {
                return; 
            }
            
            if (!canvas || !ctx) return;

            if (!gameActive) {
                document.getElementById('messageOverlay').style.display = 'none';
                gameActive = true;
                startTimer();
            }

            let dx = 0;
            let dy = 0;
            
            switch (e.key.toLowerCase()) {
                case 'arrowup':
                case 'w':
                    dy = -1;
                    break;
                case 'arrowright':
                case 'd':
                    dx = 1;
                    break;
                case 'arrowdown':
                case 's':
                    dy = 1;
                    break;
                case 'arrowleft':
                case 'a':
                    dx = -1;
                    break;
                default:
                    return;
            }

            if (['arrowup', 'arrowdown', 'arrowleft', 'arrowright', 'w', 'a', 's', 'd'].includes(e.key.toLowerCase())) {
                e.preventDefault(); 
            }
            
            movePlayer(dx, dy);
        }

        // === ИНИЦИАЛИЗАЦИЯ ИГРЫ ===
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('newMazeBtn').onclick = initGame;
            document.getElementById('replayBtn').onclick = initGame;

            document.addEventListener('keydown', handleKeyDown);

            initMobileControls();
            initGame();
        });

    </script>
</body>
</html>
